<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Paper Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/static/js/image_process.js"></script>
    <script src="/static/js/admin_app.js"></script>
    <style>
        :root { 
            --primary: #3b82f6; 
            --bg: #0f172a; 
            --panel: #1e293b; 
            --panel-light: #334155;
            --text: #f1f5f9; 
            --text-dim: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: var(--text); font-size: 13px; }
        
        [x-cloak] { display: none !important; }

        /* Layout */
        .admin-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; background: var(--panel); padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); }
        .admin-header h2 { margin: 0; font-size: 1.1rem; color: var(--primary); margin-right: 12px; }
        
        .main-layout { display: grid; grid-template-columns: 200px 1fr; gap: 12px; }
        
        /* Sidebar (Dishes) */
        .sidebar { background: var(--panel); border-radius: 6px; border: 1px solid var(--border); padding: 8px; }
        .dish-item { padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; cursor: pointer; color: var(--text-dim); transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .dish-item:hover { background: var(--panel-light); color: var(--text); }
        .dish-item.active { background: var(--primary); color: white; }
        
        select, option { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; font-size: 12px; }
        
        .device-selector select {
            background-color: #ffffff !important;
            color: #000000 !important;
            font-weight: bold !important;
            border: 2px solid var(--primary) !important;
            min-width: 180px;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            appearance: auto !important;
            -webkit-appearance: auto !important;
        }
        .device-selector option {
            background-color: #ffffff !important;
            color: #000000 !important;
            padding: 4px;
        }
        
        /* Content Area */
        .content-area { display: flex; flex-direction: column; gap: 12px; }

        /* Device Info & Gallery */
        .device-info { background: var(--panel); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .device-header { display: flex; align-items: center; gap: 16px; margin-bottom: 8px; }
        .device-header h3 { margin: 0; font-size: 0.95rem; }
        .refresh-rate-box { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-dim); }
        .refresh-rate-box input { width: 50px; text-align: center; }

        .device-meta { display: flex; gap: 10px; font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
        
        .gallery { display: flex; flex-wrap: wrap; gap: 6px; }
        .image-item { position: relative; width: 200px; height: 150px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; }
        .image-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-item .delete-btn { position: absolute; top: 0; right: 0; background: rgba(239, 68, 68, 0.9); color: white; border: none; padding: 0 3px; font-size: 9px; cursor: pointer; z-index: 10; }
        .image-item .active-badge { position: absolute; bottom: 0; left: 0; background: #10b981; color: white; font-size: 8px; padding: 1px 4px; font-weight: bold; }
        
        /* Unified Config Panel Style */
        .config-container { background: var(--panel-light); padding: 12px; border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; max-width: 550px; }
        .config-row { display: flex; align-items: center; gap: 15px; }
        .config-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        .config-group label { min-width: 65px; color: var(--text-dim); font-size: 11px; font-weight: 500; }
        .config-group select, .config-group input { flex: 1; height: 28px; font-size: 12px; }
        .config-group input[type="range"] { flex: 1; height: 12px; margin: 0; padding: 0; width: 100%; cursor: pointer; }
        .config-group .val { min-width: 35px; text-align: right; color: var(--primary); font-weight: bold; font-size: 11px; }
        
        /* Segmented Control */
        .segmented-control { display: flex; background: var(--input-bg); padding: 2px; border-radius: 4px; border: 1px solid var(--border); gap: 2px; flex: 1; height: 28px; box-sizing: border-box; }
        .segment-btn { flex: 1; background: transparent; border: none; color: var(--text-dim); font-size: 10px; cursor: pointer; border-radius: 3px; transition: 0.2s; font-weight: 600; }
        .segment-btn:hover { color: var(--text); }
        .segment-btn.active { background: var(--primary); color: white; }

        .reddit-preview-list { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; border-top: 1px solid var(--border); padding-top: 16px; }
        .reddit-post { background: var(--panel-light); border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); width: 200px; cursor: pointer; transition: transform 0.2s; position: relative; }
        .reddit-post:hover { transform: translateY(-2px); border-color: var(--primary); }
        .reddit-post img { width: 100%; height: 150px; object-fit: cover; background: #000; }
        .reddit-post .post-title { padding: 6px 6px 2px 6px; font-size: 11px; line-height: 1.3; color: var(--text); flex: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .reddit-post .post-url { padding: 0 6px 6px 6px; font-size: 9px; color: var(--primary); text-decoration: none; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; display: block; }
        .reddit-post .post-url:hover { text-decoration: underline; }
        .reddit-post .ai-debug { padding: 4px 6px; font-size: 9px; color: #818cf8; background: rgba(0,0,0,0.3); border-top: 1px solid var(--border); font-family: monospace; line-height: 1.3; word-break: break-all; white-space: normal; }
        .reddit-post .process-debug { padding: 4px 6px; font-size: 9px; color: #10b981; background: rgba(0,0,0,0.3); border-top: 1px solid var(--border); font-family: monospace; line-height: 1.3; word-break: break-all; white-space: normal; }
        .text-red { color: #ef4444 !important; font-weight: bold; }
        .reddit-post.skipped { border-color: rgba(239, 68, 68, 0.4); opacity: 0.8; }
        .reddit-post.error { border-color: #ef4444; border-width: 2px; }
        .reddit-post.error .process-debug { color: #ef4444; font-weight: bold; }

        .previews-container { display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; }
        .preview-box { display: flex; flex-direction: column; gap: 4px; }
        .preview-box h4 { margin: 0; font-size: 11px; color: var(--text-dim); }
        canvas { display: block; border: 1px solid var(--border); background: #333; max-width: 100%; height: auto; image-rendering: pixelated; }

        .btn-add { background: var(--primary); color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-add:hover { background: #2563eb; }
        .btn-save { background: #10b981; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-save:hover { background: #059669; }
        .btn-fetch { background: #6366f1; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-fetch:hover { background: #4f46e5; }
        .btn-fetch:disabled { background: #94a3b8; cursor: not-allowed; }

        .stats { font-size: 10px; color: var(--text-dim); }
        .hidden { display: none !important; }

        /* Dish Selector Row */
        .dish-selector-row { display: flex; align-items: center; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .dish-selector-row label { font-size: 12px; color: var(--text-dim); font-weight: bold; }
        .dish-toggle-group { display: flex; gap: 4px; background: var(--input-bg); padding: 3px; border-radius: 6px; border: 1px solid var(--border); }
        .dish-btn { background: transparent; border: none; color: var(--text-dim); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .dish-btn:hover { color: var(--text); background: var(--panel-light); }
        .dish-btn.active-dish { background: #10b981; color: white; font-weight: bold; position: relative; }
        .dish-btn.active-dish::after { content: "ACTIVE"; position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; font-size: 7px; padding: 1px 3px; border-radius: 3px; border: 1px solid var(--bg); }

        /* Tabs System */
        .tab-bar { display: flex; gap: 4px; margin-top: 12px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
        .tab-btn { background: var(--panel); border: 1px solid var(--border); border-bottom: none; color: var(--text-dim); padding: 8px 16px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px; transition: 0.2s; margin-bottom: -1px; }
        .tab-btn:hover { background: var(--panel-light); color: var(--text); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .tab-content { background: var(--panel); padding: 12px; border-radius: 0 0 6px 6px; border: 1px solid var(--border); border-top: none; }
        .tab-content h3 { margin: 0 0 12px 0; font-size: 0.95rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; cursor: pointer; }
        #overlay img { max-width: 98%; max-height: 98%; }
    </style>
</head>
<body x-data="adminApp" x-cloak>

    <div class="admin-header">
        <h2>E-Paper Admin</h2>
        <div class="device-selector">
            <select x-model="currentMac" @change="selectDevice($event.target.value)">
                <option value="">-- Select Device --</option>
                <template x-for="device in devices" :key="device.mac_address">
                    <option :value="device.mac_address" x-text="(device.friendly_id || device.mac_address) || 'Device'" style="color: #000000 !important; background: #ffffff !important;"></option>
                </template>
            </select>
        </div>
        <div x-show="baseUrl" class="stats" style="margin-left: auto; color: var(--primary);">
            Base URL: <span x-text="baseUrl" style="font-weight: bold;"></span>
        </div>
    </div>

    <div x-show="currentMac" class="content-area">
        <div class="device-info">
            <div class="device-header">
                <h3 x-text="deviceSettings.name || 'Device'">Device</h3>
                <div class="refresh-rate-box">
                    <label>Refresh:</label>
                    <input type="number" x-model="deviceSettings.refresh_rate" @change="saveDeviceSettings" min="10" style="width: 40px;">
                    <span>s</span>
                    
                    <label style="margin-left: 10px;">Size:</label>
                    <input type="number" x-model="deviceSettings.display_width" @change="saveDeviceSettings" min="100" style="width: 45px;">
                    <span>x</span>
                    <input type="number" x-model="deviceSettings.display_height" @change="saveDeviceSettings" min="100" style="width: 45px;">
                    
                    <label style="margin-left: 10px;">TZ:</label>
                    <select x-model="deviceSettings.timezone" @change="saveDeviceSettings" style="width: 100px;">
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">New York</option>
                        <option value="America/Chicago">Chicago</option>
                        <option value="America/Denver">Denver</option>
                        <option value="America/Los_Angeles">Los Angeles</option>
                        <option value="Europe/London">London</option>
                        <option value="Europe/Paris">Paris</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                        <option value="Asia/Shanghai">Shanghai</option>
                        <option value="Asia/Hong_Kong">Hong Kong</option>
                        <option value="Asia/Singapore">Singapore</option>
                        <option value="Asia/Seoul">Seoul</option>
                        <option value="Australia/Sydney">Sydney</option>
                        <option value="Australia/Melbourne">Melbourne</option>
                        <option value="Pacific/Auckland">Auckland</option>
                    </select>
                </div>
            </div>
            <div class="device-meta">
                <template x-if="currentMac">
                    <span x-text="`MAC: ${currentMac}`"></span>
                </template>
            </div>
            
            <!-- Dish Selector -->
            <div class="dish-selector-row" style="flex-wrap: wrap; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label>Enable Sources:</label>
                    <div class="dish-toggle-group">
                        <button class="dish-btn" :class="{ 'active-dish': deviceSettings.enabled_dishes.includes('gallery') }" @click="toggleDish('gallery')">üñºÔ∏è Gallery</button>
                        <button class="dish-btn" :class="{ 'active-dish': deviceSettings.enabled_dishes.includes('reddit') }" @click="toggleDish('reddit')">Reddit Top</button>
                        <button class="dish-btn" :class="{ 'active-dish': deviceSettings.enabled_dishes.includes('rss') }" @click="toggleDish('rss')">üì∞ Rss</button>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label>Display Mode:</label>
                    <select x-model="deviceSettings.display_mode" @change="saveDeviceSettings" style="height: 28px; font-size: 11px; padding: 2px 6px;">
                        <option value="sequence">Sequence (Cycle sources)</option>
                        <option value="random">Random (Shuffle sources)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabs Bar -->
        <div class="tab-bar">
            <button class="tab-btn" :class="{ active: currentTab === 'gallery' }" @click="showTab('gallery')">üñºÔ∏è Gallery Config</button>
            <button class="tab-btn" :class="{ active: currentTab === 'reddit' }" @click="showTab('reddit')">Reddit Config</button>
            <button class="tab-btn" :class="{ active: currentTab === 'rss' }" @click="showTab('rss')">üì∞ Rss Config</button>
        </div>

        <!-- Rss Dish Panel -->
        <div x-show="currentTab === 'rss'" class="tab-content">
            <div class="config-container" style="max-width: 600px;">
                <div class="size-row" style="border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <div class="config-group" style="flex: 1;">
                        <label>RSS URL</label>
                        <input type="text" x-model="rssConfig.url" placeholder="https://example.com/feed.xml" style="width: 100%;">
                    </div>
                    <button class="btn-fetch" @click="fetchRssNow()" :disabled="isFetchingRss" style="height: 32px; font-size: 11px; margin-top: 18px;">
                        <span x-text="isFetchingRss ? '‚è≥ Fetching...' : '‚ö° Fetch Now'"></span>
                    </button>
                </div>
                
                <div class="config-row" style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(16, 185, 129, 0.2);">
                    <div style="font-size: 11px; color: #10b981; font-weight: bold;">üì∞ General RSS Feed Parser</div>
                    <div x-html="rssStatus" style="font-size: 11px; color: var(--text-dim);">Ready</div>
                </div>

                <div class="config-row">
                    <div class="config-group">
                        <label>Bit Depth</label>
                        <div class="segmented-control">
                            <button class="segment-btn" :class="{ active: rssConfig.bit_depth === 1 }" @click="rssConfig.bit_depth = 1; saveRssConfig()">1bit (BW)</button>
                            <button class="segment-btn" :class="{ active: rssConfig.bit_depth === 2 }" @click="rssConfig.bit_depth = 2; saveRssConfig()">2bit (4G)</button>
                        </div>
                    </div>
                    <div class="config-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                        <input type="checkbox" id="rssAutoOpt" x-model="rssConfig.auto_optimize" @change="saveRssConfig()">
                        <label for="rssAutoOpt" style="margin: 0; cursor: pointer;">‚ú® AI Auto-Optimize</label>
                    </div>
                </div>
                
                <div class="config-group" x-show="rssConfig.auto_optimize" style="margin-top: 10px;">
                    <label>AI Prompt (Optional)</label>
                    <textarea x-model="rssConfig.ai_prompt" @change="saveRssConfig()" placeholder="Custom AI instructions..." style="width: 100%; height: 50px; font-size: 10px; padding: 4px; border-radius: 4px; background: #222; border: 1px solid var(--border); color: white;"></textarea>
                </div>
            </div>

            <div class="reddit-preview-list">
                <template x-for="item in rssPreview" :key="item.post_url">
                    <div class="reddit-post" style="height: auto; min-height: 200px;">
                        <!-- Image -->
                        <template x-if="item.filename">
                            <div style="position: relative; height: 120px;">
                                <img :src="'/api/bitmap/' + item.filename" style="height: 120px; width: 100%; object-fit: contain; background: #222; border-bottom: 1px solid var(--border);">
                                <div style="position: absolute; top: 4px; right: 4px; background: rgba(16, 185, 129, 0.9); color: white; font-size: 8px; padding: 2px 4px; border-radius: 3px; font-weight: bold;">DITHERED</div>
                            </div>
                        </template>
                        <template x-if="!item.filename && item.img_url">
                            <img :src="item.img_url" style="height: 120px; width: 100%; object-fit: contain; background: #222; border-bottom: 1px solid var(--border); opacity: 0.5;">
                        </template>
                        <template x-if="!item.img_url">
                            <div style="height: 120px; background: #333; display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px;">No Image</div>
                        </template>

                        <div class="post-title" x-text="item.title" style="font-weight: bold; color: var(--primary);"></div>
                        <div style="padding: 4px 6px; font-size: 10px; color: var(--text); line-height: 1.4; max-height: 80px; overflow: hidden; text-overflow: ellipsis;" x-text="item.body_text"></div>
                        <div style="padding: 4px 6px; font-size: 9px; color: var(--text-dim);" x-text="item.date"></div>
                        <div x-if="item.status === 'skip'" style="padding: 2px 6px; font-size: 9px; color: #ef4444; font-weight: bold;" x-text="'Skipped: ' + (item.reason || 'AI Decision')"></div>
                        <a :href="item.post_url" target="_blank" class="post-url" x-text="item.post_url"></a>
                    </div>
                </template>
            </div>
        </div>

        <!-- Gallery Dish Panel -->
        <div x-show="currentTab === 'gallery'" class="tab-content">
            <h3>üñºÔ∏è Gallery Manager</h3>
            <div class="gallery" style="margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                <template x-for="item in galleryItems" :key="item.id">
                    <div class="image-item" @click="showOverlay('/api/bitmap/' + item.filename)">
                        <img :src="'/api/bitmap/' + item.filename">
                        <button class="delete-btn" @click.stop="deleteImage(item.id)">√ó</button>
                    </div>
                </template>
            </div>
            
            <div class="config-container" style="max-width: 600px;">
                <div class="size-row" style="border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <input type="file" @change="handleFileUpload" accept="image/*" style="width: 180px;">
                    <button @click="uploadToGallery" class="btn-add" :disabled="isUploading">
                        <span x-text="isUploading ? '‚è≥ Uploading...' : 'Add to Gallery'"></span>
                    </button>
                    <div style="flex: 1;"></div>
                </div>

                <div class="config-row" style="background: rgba(99, 102, 241, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <button @click="aiOptimize()" :disabled="isAnalyzingAI" style="background: var(--primary); color: white; border: none; padding: 0 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: bold; height: 28px; display: flex; align-items: center; gap: 4px; min-width: 110px; flex-shrink: 0;">
                        <span x-text="isAnalyzingAI ? '‚è≥ Analyzing...' : '‚ú® AI Optimize'"></span>
                    </button>
                    <div x-text="aiInfo || 'Ready for analysis'" style="font-size: 11px; color: #818cf8; font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex: 1; text-align: right; padding-left: 12px;"></div>
                </div>

                <div class="config-row">
                    <div class="config-group">
                        <label>Gamma</label>
                        <input type="range" x-model="galleryConfig.gamma" min="0" max="7" step="1" @input="processImage()">
                        <span class="val" x-text="gammaLabels && galleryConfig && gammaLabels[galleryConfig.gamma] !== undefined ? gammaLabels[galleryConfig.gamma].toFixed(1) : '1.0'">1.0</span>
                    </div>
                    <div class="config-group">
                        <label>Sharpen</label>
                        <input type="range" x-model="galleryConfig.sharpen" min="0" max="2.0" step="0.1" @input="processImage()">
                        <span class="val" x-text="parseFloat(galleryConfig.sharpen || 0).toFixed(1)">0.0</span>
                    </div>
                </div>

                <div class="config-row">
                    <div class="config-group">
                        <label>Clip %</label>
                        <input type="range" x-model="galleryConfig.clip" min="0" max="60" @input="processImage()">
                        <span class="val" x-text="galleryConfig.clip">22</span>
                    </div>
                    <div class="config-group">
                        <label>Cost %</label>
                        <input type="range" x-model="galleryConfig.cost" min="0" max="60" @input="processImage()">
                        <span class="val" x-text="galleryConfig.cost">6</span>
                    </div>
                </div>

                <div class="config-row">
                    <div class="config-group">
                        <label>Bit Depth</label>
                        <div class="segmented-control">
                            <button class="segment-btn" :class="{ active: galleryConfig.bitDepth === 'fs' }" @click="galleryConfig.bitDepth = 'fs'; processImage()">1bit (BW)</button>
                            <button class="segment-btn" :class="{ active: galleryConfig.bitDepth === 'fs4g' }" @click="galleryConfig.bitDepth = 'fs4g'; processImage()">2bit (4G)</button>
                        </div>
                    </div>
                    <div class="config-group">
                        <label>Dither %</label>
                        <input type="range" x-model="galleryConfig.ditherStrength" min="0" max="100" @input="processImage()">
                        <span class="val" x-text="galleryConfig.ditherStrength">100</span>
                    </div>
                </div>
            </div>

            <div class="previews-container" style="margin-top: 15px;">
                <div class="preview-box">
                    <h4>Original</h4>
                    <canvas id="cOriginal"></canvas>
                </div>
                <div class="preview-box">
                    <h4>Dithered</h4>
                    <canvas id="cDither"></canvas>
                </div>
            </div>
        </div>

        <!-- Reddit Dish Panel -->
        <div x-show="currentTab === 'reddit'" class="tab-content">
            <div class="config-container" style="max-width: 600px;">
                <div class="size-row" style="border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                    <div class="config-group">
                        <label>Subreddit</label>
                        <select x-model="redditConfig.subreddit" @change="handleRedditSubChange()" style="max-width: 140px;">
                            <option value="">-- Choose --</option>
                            <optgroup label="Memes">
                                <option value="memes">r/memes</option>
                                <option value="dankmemes">r/dankmemes</option>
                                <option value="AdviceAnimals">r/AdviceAnimals</option>
                                <option value="wholesomememes">r/wholesomememes</option>
                                <option value="PrequelMemes">r/PrequelMemes</option>
                                <option value="HistoryMemes">r/HistoryMemes</option>
                                <option value="trippinthroughtime">r/trippinthroughtime</option>
                                <option value="me_irl">r/me_irl</option>
                                <option value="Antimeme">r/Antimeme</option>
                                <option value="StarterPacks">r/StarterPacks</option>
                            </optgroup>
                            <optgroup label="Photos/Art">
                                <option value="EarthPorn">r/EarthPorn</option>
                                <option value="Art">r/Art</option>
                                <option value="OldSchoolCool">r/OldSchoolCool</option>
                                <option value="MildlyInteresting">r/MildlyInteresting</option>
                                <option value="AccidentalRenaissance">r/AccidentalRenaissance</option>
                                <option value="StreetPhotography">r/StreetPhotography</option>
                                <option value="DataIsBeautiful">r/DataIsBeautiful</option>
                                <option value="WhatIsThisThing">r/WhatIsThisThing</option>
                                <option value="FoodPorn">r/FoodPorn</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="config-group">
                        <label class="compact-label">AI Auto</label>
                        <input type="checkbox" x-model="redditConfig.auto_optimize">
                    </div>
                </div>

                <div class="reddit-status-row">
                    <div id="redditStatus" x-html="redditStatus">Ready</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-outline" @click="clearRedditCache()" style="color: #ef4444; border-color: rgba(239, 68, 68, 0.3);">üóëÔ∏è Clear Cache</button>
                        <template x-if="redditConfig.auto_optimize">
                            <div style="color: #6366f1; font-size: 11px; align-self: center;">‚ú® AI Auto Enabled</div>
                        </template>
                    </div>
                </div>

                <div class="config-row">
                    <div class="config-group">
                        <label>Bit Depth</label>
                        <div class="segmented-control">
                            <button class="segment-btn" :class="{ active: redditConfig.bit_depth === 1 }" @click="setRedditBitDepth(1)">1bit (BW)</button>
                            <button class="segment-btn" :class="{ active: redditConfig.bit_depth === 2 }" @click="setRedditBitDepth(2)">2bit (4G)</button>
                        </div>
                    </div>
                    <div class="config-group" :style="redditConfig.auto_optimize ? 'opacity: 0.4; pointer-events: none;' : ''">
                        <label>Gamma</label>
                        <input type="range" x-model="redditConfig.gamma_index" min="0" max="7" step="1">
                        <span class="val" x-text="gammaLabels && redditConfig && gammaLabels[redditConfig.gamma_index] !== undefined ? gammaLabels[redditConfig.gamma_index].toFixed(1) : '1.0'">1.0</span>
                    </div>
                </div>

                <div class="config-row">
                    <div class="config-group" :style="redditConfig.auto_optimize ? 'opacity: 0.4; pointer-events: none;' : ''">
                        <label>Sharpen</label>
                        <input type="range" x-model="redditConfig.sharpen_amount" min="0" max="2.0" step="0.1">
                        <span class="val" x-text="parseFloat(redditConfig.sharpen_amount || 0).toFixed(1)">0.0</span>
                    </div>
                    <div class="config-group" :style="redditConfig.auto_optimize ? 'opacity: 0.4; pointer-events: none;' : ''">
                        <label>Dither %</label>
                        <input type="range" x-model="redditConfig.dither_strength" min="0" max="1" step="0.01" @input="redditConfig.dither_strength = parseFloat($event.target.value)">
                        <span class="val" x-text="Math.round((redditConfig.dither_strength || 0) * 100)">100</span>
                    </div>
                </div>

                <div class="config-row">
                    <div class="config-group">
                        <label>Clip %</label>
                        <input type="range" x-model="redditConfig.clip_percent" min="0" max="60">
                        <span class="val" x-text="redditConfig.clip_percent">22</span>
                    </div>
                    <div class="config-group">
                        <label>Cost %</label>
                        <input type="range" x-model="redditConfig.cost_percent" min="0" max="60">
                        <span class="val" x-text="redditConfig.cost_percent">6</span>
                    </div>
                </div>

                <div class="config-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                    <label style="color: var(--text-dim); font-size: 11px; font-weight: 500;">AI Prompt</label>
                    <textarea x-model="redditConfig.ai_prompt" placeholder="Custom AI instructions for categorization and strategy..." style="width: 100%; height: 60px; background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 6px; font-size: 11px; font-family: sans-serif; resize: vertical;"></textarea>
                </div>

                <div class="config-row">
                    <div class="config-actions" style="flex: 1; justify-content: flex-end; display: flex; gap: 8px;">
                        <button class="btn-save" @click="saveRedditConfig()" style="height: 28px; font-size: 11px; margin: 0; padding: 0 10px;">Save Config</button>
                        <button class="btn-fetch" @click="fetchRedditNow()" :disabled="isFetchingReddit" style="height: 28px; font-size: 11px; margin: 0; padding: 0 10px;">
                            <span x-text="isFetchingReddit ? '‚è≥ Saving & Fetching...' : '‚ö° Save Config and Fetch Now'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="reddit-preview-list">
                <template x-for="post in redditPreview" :key="post.id || post.url">
                    <div class="reddit-post" :class="{ 'skipped': post.status === 'skip', 'error': post.status === 'error' }" @click="showOverlay(post.filename ? '/api/bitmap/' + post.filename : post.img_url)">
                        <!-- Original Image (Always Shown) -->
                        <img :src="post.img_url" style="height: 120px; object-fit: contain; background: #222; border-bottom: 1px solid var(--border);">
                        
                        <!-- Processed Image (Only if not skipped) -->
                        <template x-if="post.filename">
                            <img :src="'/api/bitmap/' + post.filename" style="height: 150px; object-fit: cover; background: #000;">
                        </template>

                        <div class="post-title" x-text="post.title"></div>
                        <a :href="post.url" target="_blank" class="post-url" @click.stop x-text="post.url"></a>
                        
                        <!-- Simplified Debug Info -->
                        <div class="ai-debug">
                            <div x-text="post.debug_ai || 'No AI info'"></div>
                        </div>
                        <div class="process-debug">
                            <div x-text="post.debug_code || 'No code info'"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div id="overlay" @click="$el.style.display='none'"><img id="overlayImg"></div>

</body>
</html>
