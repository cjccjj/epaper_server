<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Paper Admin</title>
    <style>
        :root { 
            --primary: #3b82f6; 
            --bg: #0f172a; 
            --panel: #1e293b; 
            --panel-light: #334155;
            --text: #f1f5f9; 
            --text-dim: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: var(--text); font-size: 13px; }
        
        /* Layout */
        .admin-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; background: var(--panel); padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); }
        .admin-header h2 { margin: 0; font-size: 1.1rem; color: var(--primary); margin-right: 12px; }
        
        .main-layout { display: grid; grid-template-columns: 200px 1fr; gap: 12px; }
        
        /* Sidebar (Dishes) */
        .sidebar { background: var(--panel); border-radius: 6px; border: 1px solid var(--border); padding: 8px; }
        .dish-item { padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; cursor: pointer; color: var(--text-dim); transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .dish-item:hover { background: var(--panel-light); color: var(--text); }
        .dish-item.active { background: var(--primary); color: white; }
        .dish-item i { font-size: 14px; }

        select, input { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; font-size: 12px; }
        
        /* Content Area */
        .content-area { display: flex; flex-direction: column; gap: 12px; }

        /* Device Info & Gallery */
        .device-info { background: var(--panel); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .device-header { display: flex; align-items: center; gap: 16px; margin-bottom: 8px; }
        .device-header h3 { margin: 0; font-size: 0.95rem; }
        .refresh-rate-box { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-dim); }
        .refresh-rate-box input { width: 50px; text-align: center; }

        .device-meta { display: flex; gap: 10px; font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
        
        .gallery { display: flex; flex-wrap: wrap; gap: 6px; }
        .image-item { position: relative; width: 200px; height: 150px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; }
        .image-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-item .delete-btn { position: absolute; top: 0; right: 0; background: rgba(239, 68, 68, 0.9); color: white; border: none; padding: 0 3px; font-size: 9px; cursor: pointer; }
        
        /* Panels */
        .dish-panel { background: var(--panel); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .dish-panel h3 { margin: 0 0 10px 0; font-size: 0.9rem; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
        
        /* Reddit Panel Specific */
        .reddit-config { display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .config-group { display: flex; align-items: center; gap: 10px; }
        .config-group label { width: 80px; color: var(--text-dim); }
        .config-group select, .config-group input { flex: 1; }
        
        .reddit-preview-list { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, 200px); gap: 12px; border-top: 1px solid var(--border); padding-top: 16px; justify-content: flex-start; }
        .reddit-post { background: var(--panel-light); border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); width: 200px; cursor: pointer; transition: transform 0.2s; }
        .reddit-post:hover { transform: translateY(-2px); border-color: var(--primary); }
        .reddit-post img { width: 100%; height: 150px; object-fit: cover; background: #000; }
        .reddit-post .post-title { padding: 6px; font-size: 11px; line-height: 1.3; color: var(--text); flex: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

        /* Gallery Pipeline */
        .controls-top { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .control-row { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-bottom: 12px; }
        .control-group { display: flex; align-items: center; gap: 6px; min-width: 300px; }
        .control-group label { white-space: nowrap; font-weight: 500; min-width: 70px; }
        .control-group input[type="range"] { width: 200px; height: 4px; }
        .control-group .val { min-width: 25px; text-align: right; color: var(--primary); font-weight: bold; }

        .size-row { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 8px; }
        .size-inputs { display: flex; align-items: center; gap: 4px; }
        .size-inputs input { width: 45px; }
        
        .previews-container { display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; }
        .preview-box { display: flex; flex-direction: column; gap: 4px; }
        .preview-box h4 { margin: 0; font-size: 11px; color: var(--text-dim); }
        canvas { display: block; border: 1px solid var(--border); background: #333; max-width: 100%; height: auto; image-rendering: pixelated; }

        .btn-add { background: var(--primary); color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-add:hover { background: #2563eb; }
        .btn-save { background: #10b981; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; margin-top: 8px; align-self: flex-start; }
        .btn-save:hover { background: #059669; }
        
        .btn-fetch { background: #6366f1; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; margin-top: 8px; }
        .btn-fetch:hover { background: #4f46e5; }
        .btn-fetch:disabled { background: #94a3b8; cursor: not-allowed; }

        .config-actions { display: flex; gap: 10px; }
        
        .stats { font-size: 10px; color: var(--text-dim); margin-left: auto; }
        .hidden { display: none !important; }

        /* Dish Selector Row */
        .dish-selector-row { display: flex; align-items: center; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .dish-selector-row label { font-size: 12px; color: var(--text-dim); font-weight: bold; }
        .dish-toggle-group { display: flex; gap: 4px; background: var(--input-bg); padding: 3px; border-radius: 6px; border: 1px solid var(--border); }
        .dish-btn { background: transparent; border: none; color: var(--text-dim); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .dish-btn:hover { color: var(--text); background: var(--panel-light); }
        .dish-btn.active-dish { background: #10b981; color: white; font-weight: bold; position: relative; }
        .dish-btn.active-dish::after { content: "ACTIVE"; position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; font-size: 7px; padding: 1px 3px; border-radius: 3px; border: 1px solid var(--bg); }

        /* Tabs System */
        .tab-bar { display: flex; gap: 4px; margin-top: 12px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
        .tab-btn { background: var(--panel); border: 1px solid var(--border); border-bottom: none; color: var(--text-dim); padding: 8px 16px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px; transition: 0.2s; margin-bottom: -1px; }
        .tab-btn:hover { background: var(--panel-light); color: var(--text); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .tab-content { background: var(--panel); padding: 12px; border-radius: 0 0 6px 6px; border: 1px solid var(--border); border-top: none; }
        .tab-content h3 { margin: 0 0 12px 0; font-size: 0.95rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; cursor: pointer; }
        #overlay img { max-width: 98%; max-height: 98%; }
    </style>
</head>
<body>

    <div class="admin-header">
        <h2>E-Paper Admin</h2>
        <div class="device-selector">
            <select id="deviceSelect"><option value="">-- Select Device --</option></select>
        </div>
    </div>

    <div id="deviceView" class="hidden">
        <div class="content-area">
            <div class="device-info">
                <div class="device-header">
                    <h3 id="deviceName">Device</h3>
                    <div class="refresh-rate-box">
                        <label>Refresh:</label>
                        <input type="number" id="refreshRate" value="60" min="10" style="width: 40px;">
                        <span>s</span>
                        <label style="margin-left: 10px;">TZ:</label>
                        <select id="deviceTimezone" style="width: 120px;">
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">New York</option>
                            <option value="America/Chicago">Chicago</option>
                            <option value="America/Denver">Denver</option>
                            <option value="America/Los_Angeles">Los Angeles</option>
                            <option value="Europe/London">London</option>
                            <option value="Europe/Paris">Paris</option>
                            <option value="Asia/Tokyo">Tokyo</option>
                            <option value="Asia/Shanghai">Shanghai</option>
                            <option value="Asia/Hong_Kong">Hong Kong</option>
                            <option value="Asia/Singapore">Singapore</option>
                            <option value="Asia/Seoul">Seoul</option>
                            <option value="Australia/Sydney">Sydney</option>
                            <option value="Australia/Melbourne">Melbourne</option>
                            <option value="Pacific/Auckland">Auckland</option>
                        </select>
                    </div>
                </div>
                <div class="device-meta" id="deviceMeta"></div>
                
                <!-- Dish Selector -->
                <div class="dish-selector-row">
                    <label>Active Dish:</label>
                    <div class="dish-toggle-group">
                        <button class="dish-btn" data-dish="gallery" onclick="setActiveDish('gallery')">üñºÔ∏è Gallery</button>
                        <button class="dish-btn" data-dish="reddit" onclick="setActiveDish('reddit')">Reddit Top</button>
                    </div>
                </div>
            </div>

            <!-- Tabs Bar -->
            <div class="tab-bar">
                <button class="tab-btn" data-tab="gallery" onclick="showTab('gallery')">üñºÔ∏è Gallery Config</button>
                <button class="tab-btn" data-tab="reddit" onclick="showTab('reddit')">Reddit Config</button>
            </div>

            <!-- Gallery Dish Panel -->
            <div id="panel-gallery" class="tab-content hidden">
                <h3>üñºÔ∏è Gallery Manager</h3>
                <div class="gallery" id="gallery" style="margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;"></div>
                <div class="controls-top">
                    <div class="size-row">
                        <input type="file" id="upload" accept="image/*" style="width: 180px;">
                        <div class="size-inputs">
                            <input type="number" id="targetW" value="400"> <span>x</span>
                            <input type="number" id="targetH" value="300">
                        </div>
                        <button id="addBtn" class="btn-add">Add to Gallery</button>
                        <div class="stats" id="stats"></div>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-group">
                            <label>Gamma 2.2</label>
                            <input type="checkbox" id="gammaCorrect" style="width: auto;">
                        </div>
                        <div class="control-group">
                            <label>Clip %</label>
                            <input type="range" id="clip" min="0" max="60" value="22">
                            <span class="val"><span id="clipValue">22</span>%</span>
                        </div>
                        <div class="control-group">
                            <label>Cost %</label>
                            <input type="range" id="cost" min="0" max="60" value="6">
                            <span class="val"><span id="costValue">6</span>%</span>
                        </div>
                        <div class="control-group">
                            <label>Dither</label>
                            <select id="ditherMode">
                                <option value="burkes">Burkes (BW)</option>
                                <option value="fs4g">4G FS (Gray)</option>
                                <option value="nd4g">4G ND (Gray)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="previews-container">
                    <div class="preview-box">
                        <h4>Original</h4>
                        <canvas id="cOriginal"></canvas>
                    </div>
                    <div class="preview-box">
                        <h4>Dithered</h4>
                        <canvas id="cDither"></canvas>
                    </div>
                </div>
            </div>

            <!-- Reddit Dish Panel -->
            <div id="panel-reddit" class="tab-content hidden">
                <h3>Reddit Top Config</h3>
                <div class="reddit-config">
                    <div class="config-group">
                        <label>Subreddit</label>
                        <input type="text" id="redditSub" placeholder="e.g. memes">
                    </div>
                    <div id="redditStatus" style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">
                        Last Fetch: <span id="lastFetchTime">Never</span> | Fetch Rate: every <span id="fetchRate">3</span> hours
                    </div>
                    <div class="config-actions">
                        <button class="btn-save" onclick="saveRedditConfig()">Save Config</button>
                        <button id="fetchNowBtn" class="btn-fetch" onclick="fetchRedditNow()">‚ö° Save Config and Fetch Now</button>
                    </div>
                </div>
                <div id="redditPreview" class="reddit-preview-list">
                    <!-- Top 10 posts will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div id="overlay" onclick="this.style.display='none'"><img id="overlayImg"></div>

    <script>
        let currentMac = localStorage.getItem('lastSelectedMac') || '';
        let devices = [];
        let img = new Image();
        let activeDish = 'gallery';
        let currentTab = localStorage.getItem('lastSelectedTab') || 'gallery';
        
        const dom = {
            select: document.getElementById('deviceSelect'),
            view: document.getElementById('deviceView'),
            name: document.getElementById('deviceName'),
            meta: document.getElementById('deviceMeta'),
            gallery: document.getElementById('gallery'),
            refresh: document.getElementById('refreshRate'),
            timezone: document.getElementById('deviceTimezone'),
            upload: document.getElementById('upload'),
            targetW: document.getElementById('targetW'),
            targetH: document.getElementById('targetH'),
            clip: document.getElementById('clip'),
            cost: document.getElementById('cost'),
            gamma: document.getElementById('gammaCorrect'),
            ditherMode: document.getElementById('ditherMode'),
            stats: document.getElementById('stats'),
            cOri: document.getElementById('cOriginal'),
            cDit: document.getElementById('cDither'),
            addBtn: document.getElementById('addBtn'),
            overlay: document.getElementById('overlay'),
            overlayImg: document.getElementById('overlayImg'),
            redditSub: document.getElementById('redditSub'),
            redditPreview: document.getElementById('redditPreview'),
            fetchNowBtn: document.getElementById('fetchNowBtn')
        };
        const gOri = dom.cOri.getContext('2d');
        const gDit = dom.cDit.getContext('2d');

        async function init() {
            await fetchDevices();
            
            // Initial placeholders
            process();

            dom.select.addEventListener('change', (e) => {
                currentMac = e.target.value;
                localStorage.setItem('lastSelectedMac', currentMac);
                updateUI();
            });

            dom.refresh.addEventListener('change', async () => {
                const val = parseInt(dom.refresh.value);
                const d = devices.find(x => x.mac_address === currentMac);
                if (d) d.refresh_rate = val;
                saveSettings({refresh_rate: val});
            });

            dom.timezone.addEventListener('change', async () => {
                const val = dom.timezone.value;
                const d = devices.find(x => x.mac_address === currentMac);
                if (d) d.timezone = val;
                updateUI(); // Refresh UI to show time in new TZ
                saveSettings({timezone: val}).then(() => {
                    // Refresh devices to get updated server-calculated time
                    fetchDevices();
                });
            });

            [dom.clip, dom.cost].forEach(i => {
                i.addEventListener('input', () => {
                    let displayVal = i.value;
                    document.getElementById(i.id+'Value').textContent = displayVal;
                    process();
                });
            });

            dom.ditherMode.addEventListener('change', process);
            dom.gamma.addEventListener('change', process);

            [dom.targetW, dom.targetH].forEach(i => i.addEventListener('change', process));

            dom.upload.addEventListener('change', e => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = ev => {
                    img.onload = () => { process(); };
                    img.src = ev.target.result;
                };
                r.readAsDataURL(f);
            });

            dom.addBtn.addEventListener('click', upload);
        }

        async function saveSettings(settings) {
            if (!currentMac) return;
            await fetch(`/admin/device/${currentMac}/settings`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            });
        }

        async function setActiveDish(dish) {
            activeDish = dish;
            const d = devices.find(x => x.mac_address === currentMac);
            if (d) d.active_dish = dish;
            
            // Update Active Dish Selection Indicator ONLY
            document.querySelectorAll('.dish-btn').forEach(btn => {
                btn.classList.toggle('active-dish', btn.dataset.dish === activeDish);
            });

            await saveSettings({active_dish: dish});
        }

        function showTab(tab) {
            currentTab = tab;
            localStorage.setItem('lastSelectedTab', tab);
            
            // Update Tabs Indicator
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === currentTab);
            });

            // Show relevant panel based on TAB
            document.querySelectorAll('.tab-content').forEach(panel => {
                panel.classList.toggle('hidden', panel.id !== `panel-${currentTab}`);
            });
            
            if (currentTab === 'reddit') loadRedditPreview();
        }

        async function fetchRedditNow() {
            dom.fetchNowBtn.disabled = true;
            dom.fetchNowBtn.textContent = '‚è≥ Saving & Fetching...';
            const statusBox = document.getElementById('redditStatus');
            const originalStatus = statusBox.innerHTML;
            statusBox.innerHTML = '<span style="color: #fbbf24;">‚ö° Fetch triggered! Images are being processed in background. Please refresh preview in 5-10 seconds.</span>';
            
            try {
                // 1. Save Config first
                await saveRedditConfig(false);
                
                // 2. Trigger fetch with current config
                const config = {
                    subreddit: dom.redditSub.value
                };

                const res = await fetch('/admin/reddit/fetch_now', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (res.ok) {
                    setTimeout(async () => {
                        await loadRedditPreview();
                        dom.fetchNowBtn.disabled = false;
                        dom.fetchNowBtn.textContent = '‚ö° Save Config and Fetch Now';
                        // Keep the fetch notice for a bit then revert or update
                        setTimeout(() => { if (statusBox.innerText.includes('Fetch triggered')) statusBox.innerHTML = originalStatus; }, 10000);
                    }, 3000);
                } else {
                    statusBox.innerHTML = '<span style="color: #ef4444;">‚ùå Failed to trigger fetch.</span>';
                    dom.fetchNowBtn.disabled = false;
                    dom.fetchNowBtn.textContent = '‚ö° Save Config and Fetch Now';
                    setTimeout(() => { statusBox.innerHTML = originalStatus; }, 5000);
                }
            } catch (e) {
                statusBox.innerHTML = `<span style="color: #ef4444;">‚ùå Error: ${e}</span>`;
                dom.fetchNowBtn.disabled = false;
                dom.fetchNowBtn.textContent = '‚ö° Save Config and Fetch Now';
                setTimeout(() => { statusBox.innerHTML = originalStatus; }, 5000);
            }
        }

        async function saveRedditConfig(showAlert = true) {
            const config = {
                subreddit: dom.redditSub.value
            };
            const d = devices.find(x => x.mac_address === currentMac);
            if (d) d.reddit_config = config;
            await saveSettings({reddit_config: config});
            await loadRedditPreview();
            if (showAlert) alert('Reddit config saved!');
        }

        async function loadRedditPreview() {
            if (!currentMac) return;
            try {
                const res = await fetch(`/admin/reddit/preview/${currentMac}`);
                const data = await res.json();
                
                // Update status info
                if (data.last_update_formatted) {
                    document.getElementById('lastFetchTime').textContent = `${data.last_update_formatted} (${data.server_tz})`;
                }
                if (data.rate_hours) {
                    document.getElementById('fetchRate').textContent = data.rate_hours;
                }

                if (data.posts && data.posts.length > 0) {
                    dom.redditPreview.innerHTML = data.posts.map(post => `
                        <div class="reddit-post">
                            <img src="/api/bitmap/${Date.now()}/${post.bmp_filename}" 
                                 alt="${post.title || ''}" 
                                 onclick="showOverlay('/api/bitmap/${Date.now()}/${post.bmp_filename}')">
                            <div class="post-title">${post.title || 'Reddit Post'}</div>
                        </div>
                    `).join('');
                } else {
                    dom.redditPreview.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--text-dim);">No processed images yet. Click Fetch and wait a few seconds.</div>';
                }
            } catch (e) {
                // Silently fail if fetch is in progress or server is busy
                console.log('Reddit preview load skipped or failed:', e);
            }
        }

        function showOverlay(src) {
            dom.overlayImg.src = src;
            dom.overlay.style.display = 'flex';
        }

        async function fetchDevices() {
            const res = await fetch('/admin/devices');
            devices = await res.json();
            dom.select.innerHTML = '<option value="">-- Select Device --</option>';
            devices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.mac_address;
                opt.textContent = `${d.friendly_id} (${d.mac_address})`;
                dom.select.appendChild(opt);
            });
            
            if (currentMac) {
                dom.select.value = currentMac;
                if (!dom.select.value && devices.length > 0) {
                    currentMac = devices[0].mac_address;
                    dom.select.value = currentMac;
                }
            } else if (devices.length > 0) {
                currentMac = devices[0].mac_address;
                dom.select.value = currentMac;
            }
            updateUI();
        }

        function updateUI() {
            if (!currentMac) return;
            const d = devices.find(x => x.mac_address === currentMac);
            if (!d) { dom.view.classList.add('hidden'); return; }
            
            dom.view.classList.remove('hidden');
            dom.name.textContent = `${d.friendly_id} (${d.mac_address})`;
            dom.refresh.value = d.refresh_rate || 60;
            dom.timezone.value = d.timezone || 'UTC';
            activeDish = d.active_dish || 'gallery';

            let lastSeen = 'Never';
            if (d.last_update_time) {
                // Ensure the ISO string is treated as UTC by appending 'Z' if not present
                const timeStr = d.last_update_time.endsWith('Z') ? d.last_update_time : d.last_update_time + 'Z';
                const date = new Date(timeStr);
                lastSeen = new Intl.DateTimeFormat('en-GB', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                    timeZone: d.timezone || 'UTC'
                }).format(date).replace(/\//g, '-').replace(',', '');
            }

            dom.meta.innerHTML = `
                <span>üîã ${d.battery_voltage || '?'}V</span>
                <span>üì∂ ${d.rssi || '?'} dBm</span>
                <span title="Current local time of the device based on its timezone">‚è∞ Local Time: ${d.device_time || 'Unknown'}</span>
                <span title="Last time the device successfully requested an image">üïí Last Image Fetch: ${lastSeen}</span>
            `;
            
            // Gallery thumbnails are now only in the Gallery panel
            dom.gallery.innerHTML = d.images.map(i => `
                <div class="image-item" onclick="showFull('/api/bitmap/${Date.now()}/${i.filename}')">
                    <img src="/api/bitmap/${Date.now()}/${i.filename}">
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteImg(${i.id})">√ó</button>
                </div>
            `).join('');

            // Update Active Dish Selection Indicator
            document.querySelectorAll('.dish-btn').forEach(btn => {
                btn.classList.toggle('active-dish', btn.dataset.dish === activeDish);
            });

            // Ensure the correct tab is shown
            showTab(currentTab);

            // Update Reddit Config inputs
            if (d.reddit_config) {
                dom.redditSub.value = d.reddit_config.subreddit || 'memes';
            }
        }

        function showFull(url) {
            dom.overlayImg.src = url;
            dom.overlay.style.display = 'flex';
        }

        async function deleteImg(id) {
            if (confirm('Delete?')) {
                await fetch(`/admin/image/${id}`, {method: 'DELETE'});
                await fetchDevices();
            }
        }

        function process() {
            if (!img.src) return;
            const tw = parseInt(dom.targetW.value);
            const th = parseInt(dom.targetH.value);
            const clip = parseInt(dom.clip.value);
            const cost = parseInt(dom.cost.value);

            // 1. Resize/Crop logic (Crop resize to fill target size)
            dom.cOri.width = tw;
            dom.cOri.height = th;
            dom.cDit.width = tw;
            dom.cDit.height = th;

            const scale = Math.max(tw / img.width, th / img.height);
            const nw = img.width * scale;
            const nh = img.height * scale;
            const ox = (tw - nw) / 2;
            const oy = (th - nh) / 2;

            gOri.drawImage(img, ox, oy, nw, nh);

            // 2. Grayscale
            const imageData = gOri.getImageData(0, 0, tw, th);
            const data = imageData.data;
            const doGamma = dom.gamma.checked;
            for (let i = 0; i < data.length; i += 4) {
                let g = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                if (doGamma) {
                    g = 255 * Math.pow(g / 255, 1 / 2.2);
                }
                data[i] = data[i+1] = data[i+2] = g;
            }

            // 3. Weighted Approaching Auto-Contrast (W-Approaching)
            // Calculate histogram only for the actual image area to match dithering.html
            const hist = new Array(256).fill(0);
            let sumValues = 0;
            let pixelCount = 0;

            // Image area bounds
            const startX = Math.floor(ox);
            const startY = Math.floor(oy);
            const endX = Math.floor(ox + nw);
            const endY = Math.floor(oy + nh);

            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const i = (y * tw + x) * 4;
                    const v = data[i] | 0;
                    hist[v]++;
                    sumValues += v;
                    pixelCount++;
                }
            }

            const avg = sumValues / (pixelCount || 1);
            let totalPotentialDamage = 0;
            for (let i = 0; i < 256; i++) {
                totalPotentialDamage += hist[i] * Math.abs(i - avg);
            }

            const total = pixelCount; // Use actual image pixels instead of tw * th
            const targetArea = total * (clip / 100);
            const targetCost = totalPotentialDamage * (cost / 100);
            const minTarget = total * 0.005; // 0.5% safety clip

            let remBlack = total, remWhite = total;
            let left = 0, right = 255;
            let clippedBlack = 0, clippedWhite = 0, clippedTotal = 0, totalCost = 0;

            while (left < right && totalCost < targetCost && clippedTotal < targetArea) {
                if (remWhite >= remBlack) {
                    const count = hist[right];
                    const costVal = count * (255 - right);
                    totalCost += costVal;
                    clippedTotal += count;
                    remWhite -= count;
                    clippedWhite += count;
                    right--;
                } else {
                    const count = hist[left];
                    const costVal = count * left;
                    totalCost += costVal;
                    clippedTotal += count;
                    remBlack -= count;
                    clippedBlack += count;
                    left++;
                }
            }
            // Safety
            while (left < right && clippedBlack < minTarget) { clippedBlack += hist[left]; left++; }
            while (left < right && clippedWhite < minTarget) { clippedWhite += hist[right]; right--; }

            const acScale = 255 / (right - left || 1);
            // Apply contrast to the whole canvas (padding stays white because 255 >= right)
            for (let i = 0; i < data.length; i += 4) {
                let v = data[i];
                if (v <= left) v = 0;
                else if (v >= right) v = 255;
                else v = (v - left) * acScale;
                data[i] = data[i+1] = data[i+2] = Math.max(0, Math.min(255, v));
            }

            // 4. Dithering
            const dMode = dom.ditherMode.value;
            if (dMode === 'nd4g') {
                // No Dithering 4-Level Greyscale (4G ND)
                // Linear palette: 0, 85, 170, 255
                // Thresholds are midpoints: 42, 128, 213
                for (let y = startY; y < endY; y++) {
                    for (let x = startX; x < endX; x++) {
                        const i = (y * tw + x) * 4;
                        const old = data[i];
                        
                        let nw_val;
                        if (old < 42) nw_val = 0;
                        else if (old < 128) nw_val = 85;
                        else if (old < 213) nw_val = 170;
                        else nw_val = 255;
                        
                        data[i] = data[i+1] = data[i+2] = nw_val;
                    }
                }
            } else if (dMode === 'fs4g') {
                // Floyd-Steinberg 4-Level Greyscale (4G)
                // Linear palette: 0, 85, 170, 255
                // Thresholds are midpoints: 42, 128, 213
                for (let y = startY; y < endY; y++) {
                    for (let x = startX; x < endX; x++) {
                        const i = (y * tw + x) * 4;
                        const old = data[i];
                        
                        // Find closest 4G value using midpoints
                        let nw_val;
                        if (old < 42) nw_val = 0;
                        else if (old < 128) nw_val = 85;
                        else if (old < 213) nw_val = 170;
                        else nw_val = 255;
                        
                        const err = old - nw_val;
                        data[i] = data[i+1] = data[i+2] = nw_val;

                        const add = (nx, ny, f) => {
                            if (nx >= startX && nx < endX && ny >= startY && ny < endY) {
                                const j = (ny * tw + nx) * 4;
                                const v = data[j] + err * f;
                                const clamped = Math.max(0, Math.min(255, v));
                                data[j] = data[j+1] = data[j+2] = clamped;
                            }
                        };

                        add(x + 1, y,     7 / 16);
                        add(x - 1, y + 1, 3 / 16);
                        add(x,     y + 1, 5 / 16);
                        add(x + 1, y + 1, 1 / 16);
                    }
                }
            } else {
                // Default: Burkes BW Dithering
                for (let y = startY; y < endY; y++) {
                    for (let x = startX; x < endX; x++) {
                        const i = (y * tw + x) * 4;
                        const old = data[i];
                        const nw_val = old < 128 ? 0 : 255;
                        const err = (old - nw_val) / 32;
                        data[i] = data[i+1] = data[i+2] = nw_val;

                        const add = (nx, ny, f) => {
                            if (nx >= startX && nx < endX && ny >= startY && ny < endY) {
                                const j = (ny * tw + nx) * 4;
                                const v = data[j] + err * f;
                                const clamped = Math.max(0, Math.min(255, v));
                                data[j] = data[j+1] = data[j+2] = clamped;
                            }
                        };

                        add(x + 1, y,     8);
                        add(x + 2, y,     4);
                        add(x - 2, y + 1, 2);
                        add(x - 1, y + 1, 4);
                        add(x,     y + 1, 8);
                        add(x + 1, y + 1, 4);
                        add(x + 2, y + 1, 2);
                    }
                }
            }

            gDit.putImageData(imageData, 0, 0);
            dom.stats.textContent = `Original: ${img.width}x${img.height} | Processed: ${tw}x${th} | Range: [${left}, ${right}]`;
        }

        async function upload(e) {
            if (e) e.preventDefault();
            if (!img.src) { alert('Please select an image first'); return; }
            dom.addBtn.disabled = true;
            dom.addBtn.textContent = '...';
            dom.cDit.toBlob(async (blob) => {
                const fd = new FormData();
                fd.append('file', blob, 'processed.png');
                try {
                    const res = await fetch(`/admin/upload/${currentMac}`, { method: 'POST', body: fd });
                    if (res.ok) { 
                        dom.upload.value = ''; 
                        img = new Image(); // Clear image
                        process(); // Reset preview
                        await fetchDevices(); 
                    }
                } catch (e) { alert('Failed'); }
                finally { dom.addBtn.disabled = false; dom.addBtn.textContent = 'Add to Gallery'; }
            }, 'image/png');
        }

        init();
    </script>
</body>
</html>