<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Paper Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/static/js/image_process.js"></script>
    <script src="/static/js/admin_app.js"></script>
    <style>
        :root { 
            --primary: #3b82f6; 
            --bg: #0f172a; 
            --panel: #1e293b; 
            --panel-light: #334155;
            --text: #f1f5f9; 
            --text-dim: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 12px; background: var(--bg); color: var(--text); font-size: 13px; }
        
        [x-cloak] { display: none !important; }

        /* Layout */
        .admin-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; background: var(--panel); padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); }
        .admin-header h2 { margin: 0; font-size: 1.1rem; color: var(--primary); margin-right: 12px; }
        
        .main-layout { display: grid; grid-template-columns: 200px 1fr; gap: 12px; }
        
        /* Sidebar (Dishes) */
        .sidebar { background: var(--panel); border-radius: 6px; border: 1px solid var(--border); padding: 8px; }
        .dish-item { padding: 8px 12px; margin-bottom: 4px; border-radius: 4px; cursor: pointer; color: var(--text-dim); transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .dish-item:hover { background: var(--panel-light); color: var(--text); }
        .dish-item.active { background: var(--primary); color: white; }
        
        select, option { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; font-size: 12px; }
        
        .device-selector select {
            background-color: #ffffff;
            color: #000000;
            font-weight: bold;
            border: 2px solid var(--primary);
            min-width: 180px;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .device-selector option {
            background-color: #ffffff;
            color: #000000;
        }
        
        /* Content Area */
        .content-area { display: flex; flex-direction: column; gap: 12px; }

        /* Device Info & Gallery */
        .device-info { background: var(--panel); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .device-header { display: flex; align-items: center; gap: 16px; margin-bottom: 8px; }
        .device-header h3 { margin: 0; font-size: 0.95rem; }
        .refresh-rate-box { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-dim); }
        .refresh-rate-box input { width: 50px; text-align: center; }

        .device-meta { display: flex; gap: 10px; font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .image-item { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .image-item:hover { border-color: var(--primary); transform: translateY(-2px); }
        .image-item img { width: 100%; height: 100%; object-fit: contain; }
        .image-item .delete-btn { position: absolute; top: 0; right: 0; background: rgba(239, 68, 68, 0.9); color: white; border: none; padding: 0 3px; font-size: 9px; cursor: pointer; z-index: 10; }
        .image-item .active-badge { position: absolute; bottom: 0; left: 0; background: #10b981; color: white; font-size: 8px; padding: 1px 4px; font-weight: bold; }
        
        /* Unified Config Panel Style */
        .config-container { background: var(--panel-light); padding: 12px; border-radius: 6px; border: 1px solid var(--border); display: flex; gap: 15px; max-width: 850px; position: relative; }
        .config-main { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .config-side { width: 220px; border-left: 1px solid var(--border); padding-left: 12px; display: flex; flex-direction: column; gap: 4px; }
        .config-side.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .config-side label { font-size: 10px; color: var(--text-dim); font-weight: bold; }
        .config-side textarea { width: 100%; height: 80px; font-size: 11px; background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 4px; resize: none; }
        
        .config-row { display: flex; align-items: center; gap: 15px; }
        .config-group { display: flex; align-items: center; gap: 8px; flex: 1; }
        .config-group.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .config-group label { min-width: 65px; color: var(--text-dim); font-size: 11px; font-weight: 500; }
        .config-group select, .config-group input { flex: 1; height: 28px; font-size: 12px; }
        .config-group input[type="range"] { flex: 1; height: 12px; margin: 0; padding: 0; width: 100%; cursor: pointer; }
        .config-group .val { min-width: 35px; text-align: right; color: var(--primary); font-weight: bold; font-size: 11px; }
        
        /* Preview Grid Redesign */
        .preview-list { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; border-top: 1px solid var(--border); padding-top: 16px; }
        .preview-post { background: var(--panel-light); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; position: relative; padding: 0; }
        .preview-post:hover { border-color: var(--primary); transform: translateY(-2px); }
        
        .post-img-container { position: relative; width: 100%; display: flex; flex-direction: column; gap: 4px; padding: 6px; background: #222; }
        .post-img-orig { height: 120px; width: 100%; object-fit: contain; border: 1px solid #444; }
        .post-img-proc { height: 180px; width: 100%; object-fit: cover; border: 1px solid #000; }
        
        .post-content { padding: 10px; flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .post-title { font-size: 12px; font-weight: bold; color: var(--text); line-height: 1.3; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .post-body { font-size: 11px; color: var(--text-dim); line-height: 1.3; height: 3.9em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .post-url { font-size: 10px; color: var(--primary); text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-top: 2px; }
        
        .post-debug { margin-top: 6px; border-top: 1px solid var(--border); padding-top: 4px; }
        .ai-debug { font-size: 9px; color: #818cf8; font-family: monospace; line-height: 1.2; word-break: break-all; margin-bottom: 2px; }
        .process-debug { font-size: 9px; color: #10b981; font-family: monospace; line-height: 1.2; word-break: break-all; }
        .text-red { color: #ef4444 !important; font-weight: bold; }
        .preview-post.skipped { border-color: rgba(239, 68, 68, 0.4); opacity: 0.8; }
        .preview-post.error { border-color: #ef4444; border-width: 2px; }
        .preview-post.error .process-debug { color: #ef4444; font-weight: bold; }

        .previews-container { display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; }
        .preview-box { display: flex; flex-direction: column; gap: 4px; }
        .preview-box h4 { margin: 0; font-size: 11px; color: var(--text-dim); }
        canvas { display: block; border: 1px solid var(--border); background: #333; max-width: 100%; height: auto; image-rendering: pixelated; }

        .btn-add { background: var(--primary); color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-add:hover { background: #2563eb; }
        .btn-save { background: #10b981; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-save:hover { background: #059669; }
        .btn-fetch { background: #6366f1; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-fetch:hover { background: #4f46e5; }
        .btn-fetch:disabled { background: #94a3b8; cursor: not-allowed; }

        .stats { font-size: 10px; color: var(--text-dim); }
        .hidden { display: none !important; }

        /* Segmented Control */
        .segmented-control { display: flex; gap: 4px; background: var(--input-bg); padding: 2px; border-radius: 4px; border: 1px solid var(--border); }
        .segment-btn { flex: 1; border: none; background: transparent; color: var(--text-dim); font-size: 10px; padding: 2px 8px; cursor: pointer; border-radius: 3px; transition: 0.2s; }
        .segment-btn:hover { background: var(--panel-light); color: var(--text); }
        .segment-btn.active { background: var(--primary); color: white; font-weight: bold; }

        /* Dish Selector Row */
        .dish-selector-row { display: flex; align-items: center; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .dish-selector-row label { font-size: 12px; color: var(--text-dim); font-weight: bold; }
        .dish-toggle-group { display: flex; gap: 4px; background: var(--input-bg); padding: 3px; border-radius: 6px; border: 1px solid var(--border); }
        .dish-btn { background: transparent; border: none; color: var(--text-dim); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .dish-btn:hover { color: var(--text); background: var(--panel-light); }
        .dish-btn.enabled-dish { background: var(--panel-light); color: var(--text); border: 1px solid var(--primary); }
        .dish-btn.active-dish { background: #10b981; color: white; font-weight: bold; position: relative; border-color: #10b981; }
        .dish-btn.active-dish::after { content: "ACTIVE"; position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; font-size: 7px; padding: 1px 3px; border-radius: 3px; border: 1px solid var(--bg); z-index: 20; }

        /* Tabs System */
        .tab-bar { display: flex; gap: 4px; margin-top: 12px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
        .tab-btn { background: var(--panel); border: 1px solid var(--border); border-bottom: none; color: var(--text-dim); padding: 8px 16px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px; transition: 0.2s; margin-bottom: -1px; }
        .tab-btn:hover { background: var(--panel-light); color: var(--text); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .tab-content { background: var(--panel); padding: 12px; border-radius: 0 0 6px 6px; border: 1px solid var(--border); border-top: none; }
        .tab-content h3 { margin: 0 0 12px 0; font-size: 0.95rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; cursor: pointer; }
        #overlay img { max-width: 98%; max-height: 98%; }
    </style>
</head>
<body x-data="adminApp" x-cloak>

    <div class="admin-header">
        <h2>E-Paper Admin</h2>
        <div class="device-selector">
            <select :value="currentMac" @change="selectDevice($event.target.value)">
                <option value="">-- Select Device --</option>
                <template x-for="device in devices" :key="device.mac_address">
                    <option :value="device.mac_address" x-text="device.friendly_id || device.mac_address" :selected="device.mac_address === currentMac"></option>
                </template>
            </select>
        </div>
        <div x-show="baseUrl" class="stats" style="margin-left: auto; color: var(--primary);">
            Base URL: <span x-text="baseUrl" style="font-weight: bold;"></span>
        </div>
    </div>

    <div x-show="currentMac" class="content-area">
        <!-- Section 1: Device Configuration -->
        <div class="device-info">
            <div class="device-header">
                <h3 x-text="deviceSettings.friendly_id || 'Device'">Device</h3>
                <div class="refresh-rate-box">
                    <label>Refresh:</label>
                    <input type="number" x-model="deviceSettings.refresh_rate" @change="saveDeviceSettings" min="10" style="width: 85px;">
                    <span>s</span>
                    
                    <label style="margin-left: 10px;">Size:</label>
                    <input type="number" x-model="deviceSettings.display_width" @change="saveDeviceSettings" min="100" style="width: 70px;">
                    <span>x</span>
                    <input type="number" x-model="deviceSettings.display_height" @change="saveDeviceSettings" min="100" style="width: 70px;">
                    
                    <label style="margin-left: 10px;">TZ:</label>
                    <select x-model="deviceSettings.timezone" @change="saveDeviceSettings" style="width: 100px;">
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">New York</option>
                        <option value="America/Chicago">Chicago</option>
                        <option value="America/Denver">Denver</option>
                        <option value="America/Los_Angeles">Los Angeles</option>
                        <option value="Europe/London">London</option>
                        <option value="Europe/Paris">Paris</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                        <option value="Asia/Shanghai">Shanghai</option>
                        <option value="Asia/Hong_Kong">Hong Kong</option>
                        <option value="Asia/Singapore">Singapore</option>
                        <option value="Asia/Seoul">Seoul</option>
                        <option value="Australia/Sydney">Sydney</option>
                        <option value="Australia/Melbourne">Melbourne</option>
                        <option value="Pacific/Auckland">Auckland</option>
                    </select>
                </div>
            </div>
            
            <div class="dish-selector-row" style="flex-wrap: wrap; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label>Sources:</label>
                    <div class="dish-toggle-group">
                        <button class="dish-btn" 
                                :class="{ 'enabled-dish': deviceSettings.enabled_dishes.includes('gallery'), 'active-dish': deviceSettings.active_dish === 'gallery' }" 
                                @click="toggleDish('gallery')">üñºÔ∏è Gallery</button>
                        <template x-for="source in rssSources" :key="source.id">
                            <button class="dish-btn" 
                                    :class="{ 'enabled-dish': deviceSettings.enabled_dishes.includes('rss_' + source.id), 'active-dish': deviceSettings.active_dish === 'rss_' + source.id }" 
                                    @click="toggleDish('rss_' + source.id)"
                                    x-text="'üì∞ ' + (source.name || 'RSS')"></button>
                        </template>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label>Mode:</label>
                    <select x-model="deviceSettings.display_mode" @change="saveDeviceSettings" style="height: 28px; font-size: 11px;">
                        <option value="sequence">Sequence</option>
                        <option value="random">Random</option>
                    </select>
                </div>
                <div class="stats" x-text="`MAC: ${currentMac}`" style="margin-left: auto; opacity: 0.5;"></div>
            </div>
        </div>

        <!-- Section 2: Tabbed Source Configuration -->
        <div class="tab-bar">
            <button class="tab-btn" :class="{ active: currentTab === 'gallery' }" @click="showTab('gallery')">üñºÔ∏è Gallery</button>
            <button class="tab-btn" :class="{ active: currentTab === 'rss' }" @click="showTab('rss')">üì∞ RSS</button>
        </div>

        <!-- RSS Source Panel -->
        <div x-show="currentTab === 'rss'" class="tab-content">
            <!-- RSS Source Selector -->
            <div style="margin-bottom: 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <template x-for="source in rssSources" :key="source.id">
                    <div style="display: flex; align-items: center; background: var(--panel-light); border-radius: 4px; border: 1px solid var(--border); overflow: hidden;"
                         :style="currentRssSourceId === source.id ? 'border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary);' : ''">
                        <button class="segment-btn" 
                                style="padding: 6px 12px; border: none; border-radius: 0;"
                                :class="{ active: currentRssSourceId === source.id }" 
                                @click="selectRssSource(source.id)"
                                x-text="source.name || 'RSS'"></button>
                        <button @click.stop="deleteRssSource(source.id)" 
                                style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: none; border-left: 1px solid var(--border); padding: 6px 8px; cursor: pointer;">‚úï</button>
                    </div>
                </template>
                <button x-show="rssSources.length < 5" @click="currentRssSourceId = null; rssConfig = { url: '', name: '', bit_depth: 2, auto_optimize: true, show_title: true, gamma_index: 0, sharpen_amount: 0.1, dither_strength: 1.0, clip_percent: 22, cost_percent: 6, ai_prompt: '' }"
                        class="btn-add" style="padding: 4px 10px; font-size: 11px;">+ New Source</button>
            </div>

            <div class="config-container">
                <div class="config-main">
                    <div class="config-row" style="border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                        <div class="config-group" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                            <label>Source Name</label>
                            <input type="text" x-model="rssConfig.name" placeholder="Optional Name" style="width: 100%;">
                        </div>
                        <div class="config-group" style="flex-direction: column; align-items: flex-start; gap: 4px; flex: 2;">
                            <label>RSS URL</label>
                            <div style="display: flex; width: 100%; gap: 8px;">
                                <input type="text" x-model="rssConfig.url" placeholder="https://..." style="flex: 1;">
                                <button class="btn-fetch" @click="fetchRssNow()" :disabled="isFetchingRss" style="height: 28px; padding: 0 12px;">
                                    <span x-text="isFetchingRss ? '‚è≥' : '‚ö° Fetch & Save'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-row">
    <div class="config-group">
        <input type="checkbox" id="rssAutoOpt" x-model="rssConfig.auto_optimize" @change="saveRssConfig()">
        <label for="rssAutoOpt" style="cursor: pointer; min-width: auto;">‚ú® AI Optimize</label>
    </div>
    <span class="stats" x-html="rssStatus" style="margin-left: auto; font-size: 11px;">Ready</span>
</div>

                    <div class="config-row">
                        <div class="config-group" :class="{ disabled: rssConfig.auto_optimize }">
                            <label>Gamma</label>
                            <input type="range" x-model="rssConfig.gamma_index" min="0" max="7" @change="saveRssConfig()">
                            <span class="val" x-text="gammaLabels[rssConfig.gamma_index].toFixed(1)"></span>
                        </div>
                        <div class="config-group" :class="{ disabled: rssConfig.auto_optimize }">
                            <label>Sharp</label>
                            <input type="range" x-model="rssConfig.sharpen_amount" min="0" max="2" step="0.1" @change="saveRssConfig()">
                            <span class="val" x-text="rssConfig.sharpen_amount"></span>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-group" :class="{ disabled: rssConfig.auto_optimize }">
                            <label>Dither %</label>
                            <input type="range" x-model="rssConfig.dither_strength" min="0" max="1" step="0.01" @change="saveRssConfig()">
                            <span class="val" x-text="Math.round(rssConfig.dither_strength * 100)"></span>
                        </div>
                        <div class="config-group">
                            <label>Bit Depth</label>
                            <div class="segmented-control">
                                <button class="segment-btn" :class="{ active: rssConfig.bit_depth === 1 }" @click="rssConfig.bit_depth = 1; saveRssConfig()">1bit</button>
                                <button class="segment-btn" :class="{ active: rssConfig.bit_depth === 2 }" @click="rssConfig.bit_depth = 2; saveRssConfig()">2bit</button>
                            </div>
                        </div>
                    </div>

                    <div class="config-row" :class="{ disabled: rssConfig.auto_optimize }">
                        <div class="config-group">
                            <label>Clip %</label>
                            <input type="range" x-model="rssConfig.clip_percent" min="0" max="60" @change="saveRssConfig()">
                            <span class="val" x-text="rssConfig.clip_percent"></span>
                        </div>
                        <div class="config-group">
                            <label>Cost %</label>
                            <input type="range" x-model="rssConfig.cost_percent" min="0" max="60" @change="saveRssConfig()">
                            <span class="val" x-text="rssConfig.cost_percent"></span>
                        </div>
                    </div>
                </div>

                <div class="config-side" :class="{ disabled: !rssConfig.auto_optimize }">
                    <label>AI PROMPT</label>
                    <textarea x-model="rssConfig.ai_prompt" @change="saveRssConfig()" placeholder="Custom AI instructions..."></textarea>
                </div>
            </div>

            <div class="preview-list" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));">
                <template x-for="item in rssPreview" :key="item.id || item.post_url">
                    <div class="preview-post" :class="{ 'skipped': item.status === 'skip', 'error': item.status === 'error' }" style="padding: 0; background: var(--panel);">
                        <div class="post-img-container" style="padding: 0; background: #000;">
                            <template x-if="item.filename">
                                <img :src="'/api/bitmap/' + item.filename" class="post-img-proc" @click="showOverlay('/api/bitmap/' + item.filename)" 
                                     style="cursor: zoom-in; height: 180px; width: 100%; object-fit: contain;" title="Click to zoom processed">
                            </template>
                            <template x-if="!item.filename && item.img_url">
                                <img :src="item.img_url" class="post-img-orig" style="height: 180px; width: 100%; object-fit: contain; opacity: 0.5;">
                            </template>
                        </div>
                        <div class="post-content" style="padding: 8px;">
                            <div class="post-title" x-text="item.title" style="height: 2.8em; margin-bottom: 4px;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div class="post-debug" style="margin: 0; border: none; padding: 0;">
                                    <div class="ai-debug" x-text="item.debug_ai || ''"></div>
                                    <div class="process-debug" x-text="item.debug_code || ''"></div>
                                </div>
                                <a :href="item.post_url" target="_blank" class="post-url" style="color: var(--primary); font-size: 14px;">üîó</a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Gallery Dish Panel -->
        <div x-show="currentTab === 'gallery'" class="tab-content">
            <div class="previews-container" style="margin-bottom: 15px;">
                <div class="preview-box">
                    <h4>Original</h4>
                    <canvas id="cOriginal"></canvas>
                </div>
                <div class="preview-box">
                    <h4>Processed</h4>
                    <canvas id="cDither" @click="showOverlay($el.toDataURL())" style="cursor: zoom-in;"></canvas>
                </div>
            </div>

            <div class="config-container" style="margin-bottom: 20px;">
                <div class="config-main">
                    <div class="config-row" style="border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                        <input type="file" @change="handleFileUpload" accept="image/*" style="width: 180px;">
                        <button @click="uploadToGallery" class="btn-add" :disabled="isUploading" style="height: 28px; padding: 0 12px;">
                            <span x-text="isUploading ? '‚è≥ Uploading...' : 'Add to Gallery'"></span>
                        </button>
                    </div>

                    <div class="config-row">
                        <div class="config-group">
                            <input type="checkbox" id="galleryAutoOpt" x-model="galleryConfig.auto_optimize" @change="aiOptimize()">
                            <label for="galleryAutoOpt" style="cursor: pointer; min-width: auto;">‚ú® AI Optimize</label>
                            <span x-text="aiInfo" style="font-size: 10px; color: #818cf8; margin-left: 8px;"></span>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-group" :class="{ disabled: galleryConfig.auto_optimize }">
                            <label>Gamma</label>
                            <input type="range" x-model="galleryConfig.gamma" min="0" max="7" step="1" @input="processImage()">
                            <span class="val" x-text="gammaLabels[galleryConfig.gamma].toFixed(1)"></span>
                        </div>
                        <div class="config-group" :class="{ disabled: galleryConfig.auto_optimize }">
                            <label>Sharp</label>
                            <input type="range" x-model="galleryConfig.sharpen" min="0" max="2.0" step="0.1" @input="processImage()">
                            <span class="val" x-text="parseFloat(galleryConfig.sharpen).toFixed(1)"></span>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-group" :class="{ disabled: galleryConfig.auto_optimize }">
                            <label>Dither %</label>
                            <input type="range" x-model="galleryConfig.ditherStrength" min="0" max="100" @input="processImage()">
                            <span class="val" x-text="galleryConfig.ditherStrength"></span>
                        </div>
                        <div class="config-group">
                            <label>Bit Depth</label>
                            <div class="segmented-control">
                                <button class="segment-btn" :class="{ active: galleryConfig.bitDepth === 'fs' }" @click="galleryConfig.bitDepth = 'fs'; processImage()">1bit</button>
                                <button class="segment-btn" :class="{ active: galleryConfig.bitDepth === 'fs4g' }" @click="galleryConfig.bitDepth = 'fs4g'; processImage()">2bit</button>
                            </div>
                        </div>
                    </div>

                    <div class="config-row" :class="{ disabled: galleryConfig.auto_optimize }">
                        <div class="config-group">
                            <label>Clip %</label>
                            <input type="range" x-model="galleryConfig.clip" min="0" max="60" @input="processImage()">
                            <span class="val" x-text="galleryConfig.clip"></span>
                        </div>
                        <div class="config-group">
                            <label>Cost %</label>
                            <input type="range" x-model="galleryConfig.cost" min="0" max="60" @input="processImage()">
                            <span class="val" x-text="galleryConfig.cost"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="gallery">
                <template x-for="item in galleryItems" :key="item.id">
                    <div class="image-item" @click="showOverlay('/api/bitmap/' + item.filename)">
                        <img :src="'/api/bitmap/' + item.filename">
                        <button class="delete-btn" @click.stop="deleteImage(item.id)">√ó</button>
                        <template x-if="item.filename === deviceSettings.last_served_image">
                            <div class="active-badge">ACTIVE</div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

    </div>

    <div id="overlay" @click="$el.style.display='none'"><img id="overlayImg"></div>

</body>
</html>
